# ---------------------------------------------------------
# WARNING: This file is generated by:
# ./hack/local-csi-driver-charts-sync/local-csi-driver-charts-sync.sh
#
# DO NOT MODIFY THIS FILE DIRECTLY!
# ---------------------------------------------------------

---
# Source: local-csi-driver/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: csi-local-node
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kaito.labels" . | nindent 4 }}
---
# Source: local-csi-driver/templates/node-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: csi-local-node-role
  labels:
    {{- include "kaito.labels" . | nindent 4 }}
rules:
- apiGroups:
  - ""
  resources:
  - events
  - persistentvolumes
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - nodes
  - pods
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims
  verbs:
  - get
  - list
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims/status
  verbs:
  - patch
  - update
- apiGroups:
  - ""
  resources:
  - pods
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - apps
  - extensions
  resources:
  - daemonsets
  - replicasets
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - storage.k8s.io
  resources:
  - csidrivers
  - csistoragecapacities
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - storage.k8s.io
  resources:
  - csinodes
  - storageclasses
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - storage.k8s.io
  resources:
  - volumeattachments
  - volumeattachments/status
  verbs:
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
---
# Source: local-csi-driver/templates/node-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: csi-local-node-binding
  labels:
    {{- include "kaito.labels" . | nindent 4 }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: csi-local-node-role
subjects:
- kind: ServiceAccount
  name: csi-local-node
  namespace: {{ .Release.Namespace }}
---
# Source: local-csi-driver/templates/daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: csi-local-node
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kaito.labels" . | nindent 4 }}
spec:
  selector:
    matchLabels:
      app: csi-local-node
  template:
    metadata:
      labels:
        app: csi-local-node
      annotations:
        kubectl.kubernetes.io/default-container: driver
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values:
                - amd64
                - arm64
              - key: kubernetes.io/os
                operator: In
                values:
                - linux

      containers:

      - name: driver
        args:
        - --node-name=$(NODE_NAME)
        - --pod-name=$(POD_NAME)
        - --namespace=$(POD_NAMESPACE)
        - --csi-bind-address=unix:///csi/csi.sock
        - --webhook-port=9443
        - --worker-threads=100
        - --kube-api-qps=100
        - --kube-api-burst=200
        - --metrics-bind-address=:8080
        - --metrics-secure=false
        - --health-probe-bind-address=:8081
        - --trace-address=
        - --trace-sample-rate=1000000
        - --trace-service-id=$(POD_NAME)
        - --v=2
        command:
        - /local-csi-driver
        env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        image: "mcr.microsoft.com/acstor/local-csi-driver:v0.2.3"
        imagePullPolicy: IfNotPresent
        livenessProbe:
          httpGet:
            path: /healthz
            port: health
          initialDelaySeconds: 15
          periodSeconds: 20
        ports:
        - containerPort: 9443
          name: webhook-server
          protocol: TCP
        - containerPort: 8080
          name: metrics
          protocol: TCP
        - containerPort: 8081
          name: health
          protocol: TCP
        readinessProbe:
          httpGet:
            path: /readyz
            port: health
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            memory: 600Mi
          requests:
            cpu: 10m
            memory: 60Mi
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
            - SYS_ADMIN
          privileged: true
        terminationMessagePath: /tmp/termination-log
        terminationMessagePolicy: FallbackToLogsOnError
        volumeMounts:
        - mountPath: /dev
          name: device
        - mountPath: /csi
          name: csi-socket-dir
        - mountPath: /var/lib/kubelet/
          mountPropagation: Bidirectional
          name: mountpoint-dir

      - name: csi-provisioner
        args:
        - --csi-address=/csi/csi.sock
        - --node-deployment
        - --http-endpoint=:8090
        - --retry-interval-start=1s
        - --retry-interval-max=30s
        - --worker-threads=100
        - --kube-api-qps=100
        - --kube-api-burst=200
        - --extra-create-metadata
        - --feature-gates=Topology=true
        - --strict-topology=true
        - --enable-capacity
        - --capacity-ownerref-level=0
        - --capacity-poll-interval=15s
        - --v=2
        env:
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        image: "mcr.microsoft.com/oss/v2/kubernetes-csi/csi-provisioner:v5.2.0"
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 1
          initialDelaySeconds: 10
          periodSeconds: 20
          tcpSocket:
            port: provisioner
          timeoutSeconds: 10
        ports:
        - containerPort: 8090
          name: provisioner
          protocol: TCP
        resources:
          limits:
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 20Mi
        volumeMounts:
        - mountPath: /csi
          name: csi-socket-dir

      - name: csi-resizer
        args:
        - --csi-address=/csi/csi.sock
        - --timeout=240s
        - --handle-volume-inuse-error=true
        - --http-endpoint=:8091
        - --v=2
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        image: "mcr.microsoft.com/oss/v2/kubernetes-csi/csi-resizer:v1.13.2"
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8091
          name: resizer
          protocol: TCP
        resources:
          limits:
            memory: 500Mi
          requests:
            cpu: 10m
            memory: 20Mi
        volumeMounts:
        - mountPath: /csi
          name: csi-socket-dir

      - name: csi-registrar
        args:
        - --csi-address=/csi/csi.sock
        - --kubelet-registration-path=/var/lib/kubelet/plugins/localdisk.csi.acstor.io/csi.sock
        - --http-endpoint=:8092
        - --v=1
        env:
        image: "mcr.microsoft.com/oss/v2/kubernetes-csi/csi-node-driver-registrar:v2.13.0"
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 1
          httpGet:
            path: /healthz
            port: registrar
          initialDelaySeconds: 5
          periodSeconds: 20
          timeoutSeconds: 5
        ports:
        - containerPort: 8092
          name: registrar
          protocol: TCP
        resources:
          limits:
            memory: 100Mi
          requests:
            cpu: 10m
            memory: 20Mi
        volumeMounts:
        - mountPath: /csi
          name: csi-socket-dir
        - mountPath: /registration
          name: registration-dir

      hostPID: true
      nodeSelector:
        {}
      priorityClassName: system-node-critical
      securityContext:
        seccompProfile:
          type: Unconfined
      serviceAccountName: csi-local-node
      terminationGracePeriodSeconds: 60
      tolerations:
        - effect: NoSchedule
          operator: Exists
        - effect: NoExecute
          operator: Exists
      volumes:
      - hostPath:
          path: /dev
          type: Directory
        name: device
      - hostPath:
          path: /var/lib/kubelet/plugins/localdisk.csi.acstor.io/
          type: DirectoryOrCreate
        name: csi-socket-dir
      - hostPath:
          path: /var/lib/kubelet/plugins_registry/
          type: Directory
        name: registration-dir
      - hostPath:
          path: /var/lib/kubelet/
          type: DirectoryOrCreate
        name: mountpoint-dir
