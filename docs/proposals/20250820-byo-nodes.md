---
title: Redesign BYO Nodes Scenario 
authors:
  - "Jonathan Tong"
reviewers:
  - "Jonathan Tong"
creation-date: `2025-08-20`
last-updated: `2025-08-20`
status: provisional
---

# Title

Redesign BYO Nodes Scenario and Deprecate `preferredNodes` field

## Glossary

- BYO nodes: bring-your-own nodes
- NAP: node auto-provisioning

## Summary

This proposal aims to redesign the bring-your-own (BYO) use case and deprecate the `preferredNodes` list from the resource spec. The existing BYO scenario is handled by the `preferredNodes` list, and instead BYO nodes will only need to match the Workspace label selector.

## Motivation

The initial BYO nodes scenario was implemented with the `preferredNodes` list, where users would specify the names of the nodes they want to use in the Workspace spec. This approach had several issues that pertain to the design, not just the code, so rather than attempting to introduce awkward fixes one at a time, we will redesign the BYO nodes scenario to simplify the user experience and improve the overall system architecture. The existing limiations are as follows:

1. In order for any node to be selected by the Workspace, it must be labeled to match the Workspace label selector. This is the case for BYO and NAP nodes, so there already is an affiliation between BYO nodes and the Workspace, which means that providing the names of the nodes in the `preferredNodes` list is redundant. This has been mentioned several times in issues like [this](https://github.com/kaito-project/kaito/pull/1337#pullrequestreview-3122605167).
2. When NAP is enabled and the user has also provided nodes in the `preferredNodes` list, the name of the field implies that these will be scheduled first. The existing code to [select the nodes](https://github.com/kaito-project/kaito/blob/8c8585a138c4a9273de6149e184ff5b951cd4c18/pkg/utils/common.go#L243-L288) sorts them in order of priority with preferred nodes first, but there isn't a way to guarantee that the scheduler actually picks the nodes from the list out of all possible nodes. For example, if one node is needed and there's an existing NAP node with a preferred node that got added, the scheduler could pick either one. There's no clear way to have the scheduler prioritize nodes in this way, and so dropping the idea of `preferredNodes` in favor of all qualified nodes sharing the same label would be more clear to the user.

## Goals

1. Simplify the BYO nodes scenario by removing the `preferredNodes` list and relying solely on the Workspace label selector for node selection.
2. Clearly define the behavior of how user provided nodes will be handled when NAP is enabled and disabled.
3. Surface errors to the user when there is an error with their provided nodes and cannot run the workload.


## Solution Design

The new design for the BYO scenario is for the user to label them with the corresponding Workspace label selector. This also will affect the NAP feature gate, and the behavior is as follows:

- NAP disabled: All nodes matching the label selector will be selected and if the amount of nodes is less than the `count` field in the Workspace spec, an error will be returned immediately. The webhook will then verify that each node is ready/running. If the total amount of ready nodes is less than the `count`, then an error will be returned again. The Workspace will schedule the model to run on these nodes, and if the amount of nodes exceeds the `count`, any of the nodes can be selected by the scheduler.
- NAP enabled: Like the previous scenario, all the BYO nodes will be selected and verified. However, the user provided nodes must also have the matching `instanceType`. If the amount of ready nodes of the correct instance is less than the count, the auto-provisioner will create new nodes. The scheduler will not distinguish between user provided and auto provisioned nodes.

# History

- [x] 2025/08/20: Open proposal PR.
- [ ] MM/DD/YYYY: Start model integration.
- [ ] MM/DD/YYYY: Complete model support.
